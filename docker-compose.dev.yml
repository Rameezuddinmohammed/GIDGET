# Development Docker Compose configuration
version: '3.8'

services:
  # Development API service with hot reload
  api:
    build:
      context: .
      target: development
    ports:
      - "8000:8000"
      - "8001:8001"  # Debug port
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - SUPABASE_URL=http://supabase:8000
      - SUPABASE_KEY=${SUPABASE_ANON_KEY}
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=DEBUG
      - ENVIRONMENT=development
      - PYTHONPATH=/app
    depends_on:
      - neo4j
      - redis
      - supabase
    volumes:
      - .:/app
      - ./logs:/app/logs
    restart: unless-stopped
    command: ["python", "-m", "uvicorn", "src.code_intelligence.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  # Neo4j with development settings
  neo4j:
    image: neo4j:5.15-community
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=256m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
      - NEO4J_dbms_logs_debug_level=INFO
    volumes:
      - neo4j_dev_data:/data
      - neo4j_dev_logs:/logs
    restart: unless-stopped

  # Redis for development
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_dev_data:/data
    restart: unless-stopped

  # PostgreSQL for development
  supabase:
    image: supabase/postgres:15.1.0.117
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=code_intelligence_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./src/code_intelligence/database/supabase_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    restart: unless-stopped

  # Development web interface with hot reload
  web:
    build:
      context: ./src/code_intelligence/web
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000/api/v1
      - REACT_APP_WS_URL=ws://localhost:8000/ws
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./src/code_intelligence/web:/app
      - /app/node_modules
    depends_on:
      - api
    restart: unless-stopped

  # Development tools container
  devtools:
    build:
      context: .
      target: development
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - SUPABASE_URL=http://supabase:8000
      - REDIS_URL=redis://redis:6379
      - PYTHONPATH=/app
    depends_on:
      - neo4j
      - redis
      - supabase
    volumes:
      - .:/app
    command: ["tail", "-f", "/dev/null"]  # Keep container running
    profiles:
      - tools

volumes:
  neo4j_dev_data:
  neo4j_dev_logs:
  postgres_dev_data:
  redis_dev_data: